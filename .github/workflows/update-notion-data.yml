name: Update Notion Data

on:
  schedule:
    # 3ì‹œê°„ë§ˆë‹¤ ì‹¤í–‰ (00:00, 03:00, 06:00, 09:00, 12:00, 15:00, 18:00, 21:00 UTC)
    - cron: '0 */3 * * *'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

permissions:
  contents: write  # íŒŒì¼ ìˆ˜ì • ë° ì»¤ë°‹ ê¶Œí•œ

jobs:
  update-data:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Create data directory
      run: |
        mkdir -p data

    - name: Fetch Notion data
      run: |
        HTTP_STATUS=$(curl -s -w "%{http_code}" -o notion-raw.json -X POST "https://api.notion.com/v1/databases/23787a1932c481bba2c1d5f33256cc37/query" \
          -H "Authorization: Bearer ${{ secrets.NOTION_API_KEY }}" \
          -H "Notion-Version: 2022-06-28" \
          -H "Content-Type: application/json" \
          -d '{
            "page_size": 50
          }')

        echo "HTTP Status: $HTTP_STATUS"

        if [ "$HTTP_STATUS" != "200" ]; then
          echo "âŒ Notion API ì˜¤ë¥˜ (HTTP $HTTP_STATUS):"
          cat notion-raw.json
          exit 1
        fi

        echo "âœ… Notion API í˜¸ì¶œ ì„±ê³µ"

    - name: Transform data to calendar format
      run: |
        node -e "
        const fs = require('fs');

        let rawData;
        try {
          rawData = JSON.parse(fs.readFileSync('notion-raw.json', 'utf8'));
        } catch (e) {
          console.error('âŒ JSON íŒŒì‹± ì˜¤ë¥˜:', e.message);
          process.exit(1);
        }

        // API ì˜¤ë¥˜ ì‘ë‹µ í™•ì¸
        if (rawData.object === 'error') {
          console.error('âŒ Notion API ì˜¤ë¥˜:', rawData.message);
          console.error('ì½”ë“œ:', rawData.code);
          process.exit(1);
        }

        // results ë°°ì—´ í™•ì¸
        if (!rawData.results || !Array.isArray(rawData.results)) {
          console.error('âŒ ìœ íš¨í•˜ì§€ ì•Šì€ ì‘ë‹µ í˜•ì‹. results ë°°ì—´ì´ ì—†ìŠµë‹ˆë‹¤.');
          console.error('ì‘ë‹µ ë‚´ìš©:', JSON.stringify(rawData, null, 2).substring(0, 500));
          process.exit(1);
        }

        console.log('ğŸ“Š ì´ ' + rawData.results.length + 'ê°œ ê¸°ìˆ˜ ë°œê²¬');

        const calendarData = [];

        rawData.results.forEach((course, index) => {
          const props = course.properties;

          // ë””ë²„ê¹…: ì‚¬ìš© ê°€ëŠ¥í•œ ì†ì„± ì¶œë ¥
          console.log(\`\\nğŸ“‹ ê¸°ìˆ˜ \${index + 1} ì†ì„± ëª©ë¡:\`);
          Object.keys(props).forEach(key => {
            const prop = props[key];
            if (prop.type === 'date' && prop.date) {
              console.log(\`  - \${key} (date): \${prop.date.start}\`);
            } else if (prop.type === 'title' && prop.title?.[0]) {
              console.log(\`  - \${key} (title): \${prop.title[0].text?.content}\`);
            }
          });

          // ê¸°ë³¸ ì •ë³´ ì¶”ì¶œ
          const title = props.ê¸°ìˆ˜ëª…?.title?.[0]?.text?.content || \`ê°•ì˜ \${index + 1}\`;
          const category = props.ê°•ì˜ì¢…ë¥˜?.select?.name || 'SCM ê¸°ì´ˆ';
          const status = props.ìƒíƒœ?.select?.name || 'ì¤€ë¹„ì¤‘';
          const description = props.ë¹„ê³ ?.rich_text?.[0]?.text?.content || '';
          const price = props.ìˆ˜ê°•ë£Œ?.number || 0;
          const maxStudents = props.ìµœëŒ€ì¸ì›?.number || 20;
          const currentStudents = props.í˜„ì¬ë“±ë¡ì¸ì›?.number || 0;

          // ê¸°ìˆ˜ ë²ˆí˜¸ ì¶”ì¶œ (ìˆ«ì í•„ë“œ ë˜ëŠ” íƒ€ì´í‹€ì—ì„œ ì¶”ì¶œ)
          let batch = props.ê¸°ìˆ˜?.number;
          if (!batch) {
            // ê¸°ìˆ˜ í•„ë“œê°€ ì—†ìœ¼ë©´ ê¸°ìˆ˜ëª…ì—ì„œ ìˆ«ì ì¶”ì¶œ
            const batchMatch = title.match(/(\\d+)ê¸°/);
            batch = batchMatch ? parseInt(batchMatch[1]) : (index + 1);
          }
          console.log(\`  ê¸°ìˆ˜: \${batch}\`);

          // ê°•ì˜ ë‚ ì§œ ì¶”ì¶œ (ê°•ì˜(1), ê°•ì˜(2), ê°•ì˜(3))
          const lecture1 = props['ê°•ì˜(1)']?.date?.start;
          const lecture2 = props['ê°•ì˜(2)']?.date?.start;
          const lecture3 = props['ê°•ì˜(3)']?.date?.start;

          // ê³¼ì œì„¸ì…˜ ë‚ ì§œ ì¶”ì¶œ (ê³¼ì œì„¸ì…˜(1), ê³¼ì œì„¸ì…˜(2))
          const assignment1 = props['ê³¼ì œì„¸ì…˜(1)']?.date?.start;
          const assignment2 = props['ê³¼ì œì„¸ì…˜(2)']?.date?.start;

          console.log(\`\\nğŸ“… ì¶”ì¶œëœ ë‚ ì§œ:\`);
          console.log(\`  ê°•ì˜(1): \${lecture1 || 'ì—†ìŒ'}\`);
          console.log(\`  ê°•ì˜(2): \${lecture2 || 'ì—†ìŒ'}\`);
          console.log(\`  ê°•ì˜(3): \${lecture3 || 'ì—†ìŒ'}\`);
          console.log(\`  ê³¼ì œì„¸ì…˜(1): \${assignment1 || 'ì—†ìŒ'}\`);
          console.log(\`  ê³¼ì œì„¸ì…˜(2): \${assignment2 || 'ì—†ìŒ'}\`);

          // ì‚­ì œë˜ì§€ ì•Šì€ ê¸°ìˆ˜ë§Œ ì²˜ë¦¬
          if (course.archived || course.in_trash) return;

          // ê³µí†µ ê¸°ìˆ˜ ì •ë³´
          const courseInfo = {
            id: course.id,
            title,
            category,
            status,
            description,
            price,
            maxStudents,
            currentStudents,
            batch
          };

          // ê°•ì˜(1) - 1ì£¼ì°¨: ê°•ì˜ + ê³¼ì œ
          if (lecture1) {
            calendarData.push({
              name: title,
              date: lecture1,
              type: 'lecture',
              week: 1,
              label: '1ì£¼ì°¨ ê°•ì˜',
              hasAssignment: true,
              status: status,
              batch: batch,
              maxStudents: maxStudents,
              currentStudents: currentStudents,
              notionData: courseInfo
            });
          }

          // ê³¼ì œì„¸ì…˜(1) - 2ì£¼ì°¨: í”¼ë“œë°± + ê³¼ì œ
          if (assignment1) {
            calendarData.push({
              name: title,
              date: assignment1,
              type: 'assignment',
              week: 2,
              label: '2ì£¼ì°¨ í”¼ë“œë°±',
              hasAssignment: true,
              status: status,
              batch: batch,
              maxStudents: maxStudents,
              currentStudents: currentStudents,
              notionData: courseInfo
            });
          }

          // ê°•ì˜(2) - 3ì£¼ì°¨: ê°•ì˜ + ê³¼ì œ
          if (lecture2) {
            calendarData.push({
              name: title,
              date: lecture2,
              type: 'lecture',
              week: 3,
              label: '3ì£¼ì°¨ ê°•ì˜',
              hasAssignment: true,
              status: status,
              batch: batch,
              maxStudents: maxStudents,
              currentStudents: currentStudents,
              notionData: courseInfo
            });
          }

          // ê³¼ì œì„¸ì…˜(2) - 4ì£¼ì°¨: í”¼ë“œë°± + ê³¼ì œ
          if (assignment2) {
            calendarData.push({
              name: title,
              date: assignment2,
              type: 'assignment',
              week: 4,
              label: '4ì£¼ì°¨ í”¼ë“œë°±',
              hasAssignment: true,
              status: status,
              batch: batch,
              maxStudents: maxStudents,
              currentStudents: currentStudents,
              notionData: courseInfo
            });
          }

          // ê°•ì˜(3) - 5ì£¼ì°¨: ìµœì¢… ë°œí‘œ (ê³¼ì œ ì—†ìŒ)
          if (lecture3) {
            calendarData.push({
              name: title,
              date: lecture3,
              type: 'lecture',
              week: 5,
              label: '5ì£¼ì°¨ ìµœì¢…ë°œí‘œ',
              hasAssignment: false,
              status: status,
              batch: batch,
              maxStudents: maxStudents,
              currentStudents: currentStudents,
              notionData: courseInfo
            });
          }
        });

        // ë‚ ì§œìˆœ ì •ë ¬
        calendarData.sort((a, b) => new Date(a.date) - new Date(b.date));

        const output = {
          success: true,
          data: calendarData,
          lastUpdated: new Date().toISOString(),
          totalSessions: calendarData.length
        };

        fs.writeFileSync('data/schedule.json', JSON.stringify(output, null, 2));
        console.log(\`âœ… \${calendarData.length}ê°œ ì„¸ì…˜ ë°ì´í„° ì—…ë°ì´íŠ¸ ì™„ë£Œ\`);
        "

    - name: Fetch Reviews from Notion
      run: |
        HTTP_STATUS=$(curl -s -w "%{http_code}" -o reviews-raw.json -X POST "https://api.notion.com/v1/databases/243951127368492d906a3d36861aacd2/query" \
          -H "Authorization: Bearer ${{ secrets.NOTION_API_KEY }}" \
          -H "Notion-Version: 2022-06-28" \
          -H "Content-Type: application/json" \
          -d '{
            "page_size": 100
          }')

        echo "HTTP Status: $HTTP_STATUS"

        if [ "$HTTP_STATUS" != "200" ]; then
          echo "âŒ Notion Reviews API ì˜¤ë¥˜ (HTTP $HTTP_STATUS):"
          cat reviews-raw.json
          exit 1
        fi

        echo "âœ… Notion Reviews API í˜¸ì¶œ ì„±ê³µ"

    - name: Transform reviews data
      run: |
        node -e "
        const fs = require('fs');

        let rawData;
        try {
          rawData = JSON.parse(fs.readFileSync('reviews-raw.json', 'utf8'));
        } catch (e) {
          console.error('âŒ Reviews JSON íŒŒì‹± ì˜¤ë¥˜:', e.message);
          process.exit(1);
        }

        if (rawData.object === 'error') {
          console.error('âŒ Notion API ì˜¤ë¥˜:', rawData.message);
          process.exit(1);
        }

        if (!rawData.results || !Array.isArray(rawData.results)) {
          console.error('âŒ ìœ íš¨í•˜ì§€ ì•Šì€ ì‘ë‹µ í˜•ì‹');
          process.exit(1);
        }

        console.log('ğŸ“Š ì´ ' + rawData.results.length + 'ê°œ í›„ê¸° ë°œê²¬');

        const reviews = [];

        rawData.results.forEach((review, index) => {
          if (review.archived || review.in_trash) return;

          const props = review.properties;

          // ì†ì„± ì´ë¦„ í™•ì¸ì„ ìœ„í•œ ë””ë²„ê¹…
          if (index === 0) {
            console.log('\\nğŸ“‹ í›„ê¸° ì†ì„± ëª©ë¡:');
            Object.keys(props).forEach(key => {
              console.log('  - ' + key + ' (' + props[key].type + ')');
            });
          }

          // í›„ê¸° ë‚´ìš© ì¶”ì¶œ (ë‹¤ì–‘í•œ í•„ë“œëª… ì‹œë„)
          let content = '';
          const contentFields = ['í›„ê¸°ë‚´ìš©', 'í›„ê¸°', 'ë‚´ìš©', 'content', 'Content', 'Review'];
          for (const field of contentFields) {
            if (props[field]?.rich_text?.[0]?.text?.content) {
              content = props[field].rich_text[0].text.content;
              break;
            }
            if (props[field]?.title?.[0]?.text?.content) {
              content = props[field].title[0].text.content;
              break;
            }
          }

          // ë³„ì  ì¶”ì¶œ
          let rating = 5;
          const ratingFields = ['ë³„ì ', 'rating', 'Rating', 'í‰ì '];
          for (const field of ratingFields) {
            if (props[field]?.number) {
              rating = props[field].number;
              break;
            }
            if (props[field]?.select?.name) {
              rating = parseInt(props[field].select.name) || 5;
              break;
            }
          }

          // ì‘ì„±ì ì¶”ì¶œ
          let author = '';
          const authorFields = ['ì‘ì„±ì', 'ì´ë¦„', 'author', 'Author', 'Name'];
          for (const field of authorFields) {
            if (props[field]?.rich_text?.[0]?.text?.content) {
              author = props[field].rich_text[0].text.content;
              break;
            }
            if (props[field]?.title?.[0]?.text?.content) {
              author = props[field].title[0].text.content;
              break;
            }
          }

          // ë‚ ì§œ ì¶”ì¶œ
          let date = '';
          const dateFields = ['ë‚ ì§œ', 'ì‘ì„±ì¼', 'date', 'Date', 'ë“±ë¡ì¼'];
          for (const field of dateFields) {
            if (props[field]?.date?.start) {
              const d = new Date(props[field].date.start);
              date = d.getFullYear() + '.' + String(d.getMonth() + 1).padStart(2, '0');
              break;
            }
          }

          // ìƒì„±ì¼ fallback
          if (!date && review.created_time) {
            const d = new Date(review.created_time);
            date = d.getFullYear() + '.' + String(d.getMonth() + 1).padStart(2, '0');
          }

          if (content) {
            reviews.push({
              id: review.id,
              content: content,
              rating: rating,
              author: author,
              date: date
            });
            console.log('âœ“ í›„ê¸° ì¶”ê°€: ' + author + ' (' + rating + 'ì )');
          }
        });

        // ë‚ ì§œ ì—­ìˆœ ì •ë ¬ (ìµœì‹ ìˆœ)
        reviews.sort((a, b) => {
          if (!a.date) return 1;
          if (!b.date) return -1;
          return b.date.localeCompare(a.date);
        });

        const output = {
          success: true,
          data: reviews,
          lastUpdated: new Date().toISOString(),
          totalReviews: reviews.length
        };

        fs.writeFileSync('data/reviews.json', JSON.stringify(output, null, 2));
        console.log('âœ… ' + reviews.length + 'ê°œ í›„ê¸° ë°ì´í„° ì—…ë°ì´íŠ¸ ì™„ë£Œ');
        "

    - name: Commit and push if changed
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add data/schedule.json data/reviews.json
        if ! git diff --cached --exit-code; then
          git commit -m "ğŸ”„ Notion ë°ì´í„° ìë™ ì—…ë°ì´íŠ¸ $(date '+%Y-%m-%d %H:%M')"
          git push
        else
          echo "ë°ì´í„° ë³€ê²½ì‚¬í•­ ì—†ìŒ"
        fi
