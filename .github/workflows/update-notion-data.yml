name: Update Notion Data

on:
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 9ì‹œ (KST ê¸°ì¤€ 18ì‹œ UTC)ì— ìë™ ì‹¤í–‰
    - cron: '0 18 * * *'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

permissions:
  contents: write  # íŒŒì¼ ìˆ˜ì • ë° ì»¤ë°‹ ê¶Œí•œ

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Create data directory
      run: |
        mkdir -p data
        
    - name: Fetch Notion data
      run: |
        curl -X POST "https://api.notion.com/v1/databases/${{ secrets.NOTION_DATABASE_ID }}/query" \
          -H "Authorization: Bearer ${{ secrets.NOTION_API_KEY }}" \
          -H "Notion-Version: 2022-06-28" \
          -H "Content-Type: application/json" \
          -d '{
            "page_size": 50,
            "filter": {
              "or": [
                {"property": "ìƒíƒœ", "select": {"equals": "ëª¨ì§‘ì¤‘"}},
                {"property": "ìƒíƒœ", "select": {"equals": "ì§„í–‰ì¤‘"}},
                {"property": "ìƒíƒœ", "select": {"equals": "ì™„ë£Œ"}},
                {"property": "ìƒíƒœ", "select": {"equals": "ì¤€ë¹„ì¤‘"}},
                {"property": "ìƒíƒœ", "select": {"is_empty": true}}
              ]
            },
            "sorts": [
              {"property": "ê°œê°•ì¼", "direction": "ascending"}
            ]
          }' > notion-raw.json
          
    - name: Transform data to calendar format
      run: |
        node -e "
        const fs = require('fs');
        const rawData = JSON.parse(fs.readFileSync('notion-raw.json', 'utf8'));
        
        const calendarData = [];
        
        rawData.results.forEach((course, index) => {
          const props = course.properties;
          const title = props.ê°•ì˜ëª…?.title?.[0]?.text?.content || \`ê°•ì˜ \${index + 1}\`;
          const category = props.ì¹´í…Œê³ ë¦¬?.select?.name || 'SCM ê¸°ì´ˆ';
          const status = props.ìƒíƒœ?.select?.name || 'ì¤€ë¹„ì¤‘';
          const startDate = props.ê°œê°•ì¼?.date?.start;
          const description = props.ê°•ì˜ì„¤ëª…?.rich_text?.[0]?.text?.content || '';
          
          if (startDate) {
            calendarData.push({
              name: title,
              date: startDate,
              tags: [
                title,
                \`ì¹´í…Œê³ ë¦¬: \${category}\`,
                description || 'ìƒì„¸ ì„¤ëª… ì—†ìŒ'
              ],
              status: status,
              batch: 'ì‹¤ì œ Notion ë°ì´í„°',
              notionData: {
                id: course.id,
                title,
                category,
                status,
                startDate,
                description
              }
            });
          }
        });
        
        const output = {
          success: true,
          data: calendarData,
          lastUpdated: new Date().toISOString(),
          totalCourses: calendarData.length
        };
        
        fs.writeFileSync('data/schedule.json', JSON.stringify(output, null, 2));
        console.log(\`âœ… \${calendarData.length}ê°œ ê°•ì˜ ë°ì´í„° ì—…ë°ì´íŠ¸ ì™„ë£Œ\`);
        "
        
    - name: Commit and push if changed
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add data/schedule.json
        if ! git diff --cached --exit-code; then
          git commit -m "ğŸ”„ Notion ê°•ì˜ ë°ì´í„° ìë™ ì—…ë°ì´íŠ¸ $(date '+%Y-%m-%d %H:%M')"
          git push
        else
          echo "ë°ì´í„° ë³€ê²½ì‚¬í•­ ì—†ìŒ"
        fi