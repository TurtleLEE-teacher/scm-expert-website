name: Update Notion Data

on:
  schedule:
    # 3ì‹œê°„ë§ˆë‹¤ ì‹¤í–‰ (00:00, 03:00, 06:00, 09:00, 12:00, 15:00, 18:00, 21:00 UTC)
    - cron: '0 */3 * * *'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

permissions:
  contents: write  # íŒŒì¼ ìˆ˜ì • ë° ì»¤ë°‹ ê¶Œí•œ

jobs:
  update-data:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Create data directory
      run: |
        mkdir -p data

    - name: Fetch Notion data
      run: |
        HTTP_STATUS=$(curl -s -w "%{http_code}" -o notion-raw.json -X POST "https://api.notion.com/v1/databases/23787a1932c481bba2c1d5f33256cc37/query" \
          -H "Authorization: Bearer ${{ secrets.NOTION_API_KEY }}" \
          -H "Notion-Version: 2022-06-28" \
          -H "Content-Type: application/json" \
          -d '{
            "page_size": 50,
            "sorts": [
              {"property": "ê°œê°•ì¼", "direction": "ascending"}
            ]
          }')

        echo "HTTP Status: $HTTP_STATUS"

        if [ "$HTTP_STATUS" != "200" ]; then
          echo "âŒ Notion API ì˜¤ë¥˜ (HTTP $HTTP_STATUS):"
          cat notion-raw.json
          exit 1
        fi

        echo "âœ… Notion API í˜¸ì¶œ ì„±ê³µ"

    - name: Transform data to calendar format
      run: |
        node -e "
        const fs = require('fs');

        let rawData;
        try {
          rawData = JSON.parse(fs.readFileSync('notion-raw.json', 'utf8'));
        } catch (e) {
          console.error('âŒ JSON íŒŒì‹± ì˜¤ë¥˜:', e.message);
          process.exit(1);
        }

        // API ì˜¤ë¥˜ ì‘ë‹µ í™•ì¸
        if (rawData.object === 'error') {
          console.error('âŒ Notion API ì˜¤ë¥˜:', rawData.message);
          console.error('ì½”ë“œ:', rawData.code);
          process.exit(1);
        }

        // results ë°°ì—´ í™•ì¸
        if (!rawData.results || !Array.isArray(rawData.results)) {
          console.error('âŒ ìœ íš¨í•˜ì§€ ì•Šì€ ì‘ë‹µ í˜•ì‹. results ë°°ì—´ì´ ì—†ìŠµë‹ˆë‹¤.');
          console.error('ì‘ë‹µ ë‚´ìš©:', JSON.stringify(rawData, null, 2).substring(0, 500));
          process.exit(1);
        }

        console.log('ğŸ“Š ì´ ' + rawData.results.length + 'ê°œ í•­ëª© ë°œê²¬');

        const calendarData = [];

        rawData.results.forEach((course, index) => {
          const props = course.properties;
          const title = props.ê°•ì˜ëª…?.title?.[0]?.text?.content || \`ê°•ì˜ \${index + 1}\`;
          const category = props.ì¹´í…Œê³ ë¦¬?.select?.name || 'SCM ê¸°ì´ˆ';
          const status = props.ìƒíƒœ?.select?.name || 'ì¤€ë¹„ì¤‘';
          const startDate = props.ê°œê°•ì¼?.date?.start;
          const description = props.ê°•ì˜ì„¤ëª…?.rich_text?.[0]?.text?.content || '';

          // ê°œê°•ì¼ì´ ìˆëŠ” í•­ëª©ë§Œ í¬í•¨
          if (!course.archived && !course.in_trash && startDate) {
            calendarData.push({
              name: title,
              date: startDate,
              tags: [
                title,
                \`ì¹´í…Œê³ ë¦¬: \${category}\`,
                description || 'ìƒì„¸ ì„¤ëª… ì—†ìŒ'
              ],
              status: status,
              notionData: {
                id: course.id,
                title,
                category,
                status,
                startDate,
                description
              }
            });
          }
        });

        const output = {
          success: true,
          data: calendarData,
          lastUpdated: new Date().toISOString(),
          totalCourses: calendarData.length
        };

        fs.writeFileSync('data/schedule.json', JSON.stringify(output, null, 2));
        console.log(\`âœ… \${calendarData.length}ê°œ ê°•ì˜ ë°ì´í„° ì—…ë°ì´íŠ¸ ì™„ë£Œ\`);
        "

    - name: Commit and push if changed
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add data/schedule.json
        if ! git diff --cached --exit-code; then
          git commit -m "ğŸ”„ Notion ê°•ì˜ ë°ì´í„° ìë™ ì—…ë°ì´íŠ¸ $(date '+%Y-%m-%d %H:%M')"
          git push
        else
          echo "ë°ì´í„° ë³€ê²½ì‚¬í•­ ì—†ìŒ"
        fi
